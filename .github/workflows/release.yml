name: Release Build

on:
  push:
    branches:
      - main
    paths:
      - 'pom.xml'     # ä»…å½“ pom.xml æ”¹åŠ¨æ—¶è§¦å‘

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      # æ‹‰å–å®Œæ•´å†å²è®°å½•
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # è®¾ç½® JDK 1.8
      - name: Set up JDK 1.8
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '8'
          server-id: central
          server-username: SERVER_USERNAME
          server-password: SERVER_PASSWORD
          gpg-private-key: ${{ secrets.GPG_SECRET }}
          gpg-passphrase: GPG_PASSPHRASE

      # è·å–å½“å‰ç‰ˆæœ¬å·
      - name: Get current project version
        id: version
        run: |
          VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          echo "PROJECT_VERSION=$VERSION" >> $GITHUB_ENV
          echo "ğŸ“¦ Detected version: $VERSION"

      # è·å–ä¸Šä¸€ä¸ªç‰ˆæœ¬ tagï¼ˆæŒ‰æ—¶é—´æ’åºï¼‰
      - name: Get previous tag
        id: prev_tag
        run: |
          PREV_TAG=$(git tag --sort=-creatordate | grep '^v' | head -n 1 || echo "")
          echo "PREV_TAG=$PREV_TAG" >> $GITHUB_ENV
          echo "Last version tag: $PREV_TAG"

      # æ£€æŸ¥ç‰ˆæœ¬æ˜¯å¦é€’å¢
      - name: Verify version increment
        if: env.PREV_TAG != ''
        run: |
          PREV_VER=${PREV_TAG#v}
          echo "ğŸ” Comparing $PREV_VER â†’ ${PROJECT_VERSION}"
          if [ "$(printf '%s\n' "$PREV_VER" "${PROJECT_VERSION}" | sort -V | head -n1)" = "${PROJECT_VERSION}" ] && [ "$PREV_VER" != "${PROJECT_VERSION}" ]; then
            echo "âœ… Version increment confirmed"
          elif [ "$PREV_VER" = "${PROJECT_VERSION}" ]; then
            echo "âŒ Version unchanged (${PROJECT_VERSION}), skipping release."
            exit 0
          else
            echo "âŒ Version appears to be lower than previous ($PREV_VER â†’ ${PROJECT_VERSION})."
            exit 1
          fi

      # æ£€æŸ¥è¯¥ tag æ˜¯å¦å·²å­˜åœ¨ï¼ˆé¿å…é‡å¤æ¨é€ï¼‰
      - name: Check if tag exists
        id: check_tag
        run: |
          if git rev-parse "v${PROJECT_VERSION}" >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_ENV
            echo "âš ï¸ Tag v${PROJECT_VERSION} already exists. Skipping release."
          else
            echo "exists=false" >> $GITHUB_ENV
          fi

      # åˆ›å»ºå¹¶æ¨é€æ–° tag
      - name: Create and push tag
        if: env.exists == 'false'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag "v${PROJECT_VERSION}"
          git push origin "v${PROJECT_VERSION}"
          echo "ğŸ·ï¸ Created tag v${PROJECT_VERSION}"

      # ç”Ÿæˆ Release Noteï¼ˆè‡ªåŠ¨æ±‡æ€» commitï¼‰
      - name: Generate release notes
        id: notes
        run: |
          if [ -z "${PREV_TAG}" ]; then
            NOTES=$(git log --pretty=format:"- %s" -n 20)
          else
            NOTES=$(git log ${PREV_TAG}..HEAD --pretty=format:"- %s")
          fi
          echo "RELEASE_NOTES<<EOF" >> $GITHUB_ENV
          echo "$NOTES" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          echo "ğŸ“ Generated release notes:"
          echo "$NOTES"

      # æ„å»ºé¡¹ç›®
      - name: Build with Maven
        run: mvn clean package -DskipTests

      # å‘å¸ƒåˆ° Apache Maven Central
      - name: Publish to Apache Maven Central
        run: mvn deploy -Dmaven.test.skip=true
        env:
          SERVER_USERNAME: ${{ secrets.SERVER_USERNAME }}
          SERVER_PASSWORD: ${{ secrets.SERVER_PASSWORD }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSWORD }}

      # åˆ›å»º GitHub Release
      - name: Create GitHub Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ env.PROJECT_VERSION }}
          release_name: Release v${{ env.PROJECT_VERSION }}
          body: ${{ env.RELEASE_NOTES }}
          draft: false
          prerelease: false

      # ä¸Šä¼  JAR åˆ° Release
      - name: Upload JAR to Release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: target/sdk-${{ env.PROJECT_VERSION }}.jar
          asset_name: sdk-${{ env.PROJECT_VERSION }}.jar
          asset_content_type: application/java-archive
